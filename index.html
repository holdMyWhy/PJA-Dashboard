import React, { useState, useEffect } from 'react';
import Papa from 'papaparse';
import { 
  BarChart, Bar, ScatterChart, Scatter, ZAxis,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell
} from 'recharts';

const PalmJebelAliDashboard = () => {
  const [properties, setProperties] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [typeFilter, setTypeFilter] = useState('All');
  const [configFilter, setConfigFilter] = useState('All');
  const [filteredProperties, setFilteredProperties] = useState([]);
  const [sortConfig, setSortConfig] = useState({ key: 'Layout Name', direction: 'ascending' });
  const [propertyTypes, setPropertyTypes] = useState(['All']);
  const [configTypes, setConfigTypes] = useState(['All']);
  
  // Chart data states
  const [sizeComparisonData, setSizeComparisonData] = useState([]);
  const [priceComparisonData, setPriceComparisonData] = useState([]);
  const [scatterPlotData, setScatterPlotData] = useState([]);
  
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];
  
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);
        const response = await window.fs.readFile('Master  PJA Master 1.csv', { encoding: 'utf8' });
        const parsedData = Papa.parse(response, {
          header: true,
          skipEmptyLines: true
        });
        
        // Clean and process the data
        const cleanedData = parsedData.data
          .filter(row => row['Type'] && row['Type'].trim() !== '')
          .map(property => {
            const cleanProperty = { ...property };
            
            // Clean BUA (Built-Up Area)
            if (property['BUA (in sqft)']) {
              const buaValue = property['BUA (in sqft)'].toString().replace(/,/g, '');
              cleanProperty['BUA_Numeric'] = parseFloat(buaValue);
            }
            
            // Clean Plot Size
            if (property['Plot Size (in sqft)']) {
              let plotValue = property['Plot Size (in sqft)'].toString();
              if (plotValue.includes('~')) {
                plotValue = plotValue.replace(/~/g, '').trim();
              }
              if (plotValue.includes('-')) {
                // For ranges, take the average
                const [min, max] = plotValue.split('-').map(v => parseFloat(v.replace(/,/g, '').trim()));
                plotValue = (min + max) / 2;
              } else {
                plotValue = plotValue.replace(/,/g, '');
              }
              cleanProperty['Plot_Numeric'] = parseFloat(plotValue);
            }
            
            // Clean Launch Price
            if (property['Launched Price (in AED)']) {
              const price = property['Launched Price (in AED)'].toString();
              const priceMatch = price.match(/(\d+\.?\d*)M/);
              if (priceMatch) {
                cleanProperty['Launch_Price_M'] = parseFloat(priceMatch[1]);
              } else if (!isNaN(parseFloat(price.replace(/,/g, '')))) {
                cleanProperty['Launch_Price_M'] = parseFloat(price.replace(/,/g, '')) / 1000000;
              }
            }
            
            // Clean BUA PSF
            if (property['BUA PSF (in AED Per sqft)']) {
              const buaPsf = property['BUA PSF (in AED Per sqft)'].toString();
              if (buaPsf.includes('-')) {
                // For ranges, take the average
                const [min, max] = buaPsf.split('-').map(v => parseFloat(v.replace(/,/g, '').trim()));
                cleanProperty['BUA_PSF_Numeric'] = (min + max) / 2;
              } else {
                const psfValue = buaPsf.replace(/[~,]/g, '').replace(/\s+\(avg\)/g, '');
                cleanProperty['BUA_PSF_Numeric'] = parseFloat(psfValue);
              }
            }
            
            // Clean Plot PSF
            if (property['Plot PSF (in AED Per sqft)']) {
              const plotPsf = property['Plot PSF (in AED Per sqft)'].toString();
              if (plotPsf.includes('-')) {
                // For ranges, take the average
                const [min, max] = plotPsf.split('-').map(v => parseFloat(v.replace(/,/g, '').trim()));
                cleanProperty['Plot_PSF_Numeric'] = (min + max) / 2;
              } else {
                const psfValue = plotPsf.replace(/[~,]/g, '').replace(/\s+\(avg\)/g, '');
                cleanProperty['Plot_PSF_Numeric'] = parseFloat(psfValue);
              }
            }
            
            // Extract number of bedrooms from Config
            if (property['Config']) {
              const bedroomMatch = property['Config'].match(/(\d+)/);
              if (bedroomMatch) {
                cleanProperty['Bedrooms'] = parseInt(bedroomMatch[1]);
              }
            }
            
            return cleanProperty;
          });
        
        setProperties(cleanedData);
        setFilteredProperties(cleanedData);
        
        // Extract unique property types and configs
        const types = ['All', ...new Set(cleanedData.map(p => p['Type']))];
        setPropertyTypes(types);
        
        const configs = ['All', ...new Set(cleanedData
          .filter(p => p['Config'])
          .map(p => p['Config'].trim()))];
        setConfigTypes(configs);
        
        // 1. Size comparison by property type
        const sizeByType = {};
        cleanedData.forEach(property => {
          if (property['Type'] && property['BUA_Numeric']) {
            if (!sizeByType[property['Type']]) {
              sizeByType[property['Type']] = {
                buaTotal: 0,
                buaCount: 0,
                plotTotal: 0,
                plotCount: 0
              };
            }
            
            sizeByType[property['Type']].buaTotal += property['BUA_Numeric'];
            sizeByType[property['Type']].buaCount++;
            
            if (property['Plot_Numeric']) {
              sizeByType[property['Type']].plotTotal += property['Plot_Numeric'];
              sizeByType[property['Type']].plotCount++;
            }
          }
        });
        
        const sizeData = Object.keys(sizeByType).map(type => ({
          name: type,
          avgBUA: Math.round(sizeByType[type].buaTotal / sizeByType[type].buaCount),
          avgPlot: sizeByType[type].plotCount > 0 ? 
            Math.round(sizeByType[type].plotTotal / sizeByType[type].plotCount) : 0
        }));
        setSizeComparisonData(sizeData);
        
        // 2. Price comparison by property type
        const priceByType = {};
        cleanedData.forEach(property => {
          if (property['Type'] && property['Launch_Price_M']) {
            if (!priceByType[property['Type']]) {
              priceByType[property['Type']] = {
                total: 0,
                count: 0
              };
            }
            
            priceByType[property['Type']].total += property['Launch_Price_M'];
            priceByType[property['Type']].count++;
          }
        });
        
        const priceData = Object.keys(priceByType).map(type => ({
          name: type,
          price: Math.round(priceByType[type].total / priceByType[type].count * 10) / 10
        }));
        setPriceComparisonData(priceData);
        
        // 3. Scatter plot data (BUA vs Price)
        const scatterData = cleanedData
          .filter(p => p['BUA_Numeric'] && p['Launch_Price_M'])
          .map(p => ({
            name: p['Layout Name'],
            bua: p['BUA_Numeric'],
            price: p['Launch_Price_M'],
            type: p['Type']
          }));
        setScatterPlotData(scatterData);
        
        setLoading(false);
      } catch (error) {
        console.error("Error loading CSV data:", error);
        setError("Failed to load property data");
        setLoading(false);
      }
    };
    
    loadData();
  }, []);
  
  // Apply filters
  useEffect(() => {
    let result = [...properties];
    
    // Apply property type filter
    if (typeFilter !== 'All') {
      result = result.filter(property => property['Type'] === typeFilter);
    }
    
    // Apply config filter
    if (configFilter !== 'All') {
      result = result.filter(property => property['Config'] === configFilter);
    }
    
    // Apply sorting
    if (sortConfig.key) {
      result.sort((a, b) => {
        // Handle numeric sorting
        if (['BUA_Numeric', 'Plot_Numeric', 'Launch_Price_M', 'BUA_PSF_Numeric', 'Plot_PSF_Numeric'].includes(sortConfig.key)) {
          const aValue = a[sortConfig.key] || 0;
          const bValue = b[sortConfig.key] || 0;
          
          return sortConfig.direction === 'ascending' 
            ? aValue - bValue
            : bValue - aValue;
        } else {
          // Handle string sorting
          const aValue = (a[sortConfig.key] || '').toString();
          const bValue = (b[sortConfig.key] || '').toString();
          
          return sortConfig.direction === 'ascending'
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        }
      });
    }
    
    setFilteredProperties(result);
  }, [properties, typeFilter, configFilter, sortConfig]);
  
  // Handle sorting
  const requestSort = (key) => {
    let direction = 'ascending';
    if (sortConfig.key === key && sortConfig.direction === 'ascending') {
      direction = 'descending';
    }
    setSortConfig({ key, direction });
  };
  
  // Format numbers with commas
  const formatNumber = (num) => {
    if (num === undefined || num === null || isNaN(num)) return '-';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };
  
  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <div className="text-xl font-semibold text-blue-600 mb-4">Loading Palm Jebel Ali Data...</div>
          <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
          <p className="font-bold">Error</p>
          <p>{error}</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="bg-gray-50 min-h-screen">
      {/* Main Content */}
      <main className="max-w-7xl mx-auto p-4 sm:p-6">
        {/* Charts Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* Average Size by Property Type */}
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-lg font-medium text-gray-900 mb-4">Avg. Size by Type</h3>
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={sizeComparisonData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip formatter={(value) => [`${formatNumber(value)} sqft`, '']} />
                  <Legend />
                  <Bar dataKey="avgBUA" name="Avg. BUA (sqft)" fill="#0088FE" />
                  <Bar dataKey="avgPlot" name="Avg. Plot (sqft)" fill="#00C49F" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
          
          {/* Average Price by Property Type */}
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-lg font-medium text-gray-900 mb-4">Avg. Price by Type</h3>
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={priceComparisonData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip formatter={(value) => [`${value}M AED`, '']} />
                  <Legend />
                  <Bar dataKey="price" name="Avg. Launch Price (M AED)" fill="#8884d8">
                    {priceComparisonData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>
        
        {/* BUA vs Price Scatter Plot */}
        <div className="bg-white rounded-lg shadow p-4 mb-8">
          <h3 className="text-lg font-medium text-gray-900 mb-4">BUA vs Launch Price</h3>
          <div className="h-80">
            <ResponsiveContainer width="100%" height="100%">
              <ScatterChart
                margin={{ top: 20, right: 20, bottom: 20, left: 20 }}
              >
                <CartesianGrid />
                <XAxis 
                  type="number" 
                  dataKey="bua" 
                  name="Built-Up Area" 
                  unit=" sqft"
                  label={{ value: 'Built-Up Area (sqft)', position: 'insideBottomRight', offset: -10 }}
                />
                <YAxis 
                  type="number" 
                  dataKey="price" 
                  name="Launch Price" 
                  unit="M AED"
                  label={{ value: 'Launch Price (M AED)', angle: -90, position: 'insideLeft' }}
                />
                <ZAxis range={[100, 100]} />
                <Tooltip 
                  cursor={{ strokeDasharray: '3 3' }}
                  formatter={(value, name) => {
                    if (name === 'Built-Up Area') return [`${formatNumber(value)} sqft`, name];
                    if (name === 'Launch Price') return [`${value}M AED`, name];
                    return [value, name];
                  }}
                />
                <Legend />
                {scatterPlotData
                  .reduce((types, item) => {
                    if (!types.includes(item.type)) types.push(item.type);
                    return types;
                  }, [])
                  .map((type, index) => (
                    <Scatter 
                      key={type} 
                      name={type} 
                      data={scatterPlotData.filter(item => item.type === type)} 
                      fill={COLORS[index % COLORS.length]} 
                    />
                  ))
                }
              </ScatterChart>
            </ResponsiveContainer>
          </div>
        </div>
        
        {/* Property Size Ranges */}
        <div className="bg-white rounded-lg shadow p-4 mb-8">
          <h3 className="text-lg font-medium text-gray-900 mb-4">Property Size Ranges</h3>
          <div className="h-96">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={filteredProperties
                  .filter(p => p['BUA_Numeric'])
                  .sort((a, b) => a['BUA_Numeric'] - b['BUA_Numeric'])
                  .map(p => ({
                    name: p['Layout Name'].length > 18 
                      ? p['Layout Name'].substring(0, 18) + '...' 
                      : p['Layout Name'],
                    bua: p['BUA_Numeric'],
                    plot: p['Plot_Numeric'] || 0,
                    type: p['Type']
                  }))}
                layout="vertical"
                margin={{ top: 5, right: 30, left: 150, bottom: 5 }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis type="number" />
                <YAxis 
                  type="category" 
                  dataKey="name" 
                  width={140}
                  tick={{ fontSize: 11 }}
                />
                <Tooltip 
                  formatter={(value, name) => {
                    if (name === 'bua') return [`${formatNumber(value)} sqft`, 'Built-Up Area'];
                    if (name === 'plot') return [`${formatNumber(value)} sqft`, 'Plot Size'];
                    return [value, name];
                  }}
                />
                <Legend />
                <Bar dataKey="bua" name="Built-Up Area (sqft)" fill="#0088FE" />
                <Bar dataKey="plot" name="Plot Size (sqft)" fill="#00C49F" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
        
        {/* Properties Data Table */}
        <div className="bg-white rounded-lg shadow overflow-hidden mb-8">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('Layout Name')}
                  >
                    <div className="flex items-center">
                      Layout Name
                      {sortConfig.key === 'Layout Name' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('Type')}
                  >
                    <div className="flex items-center">
                      Type
                      {sortConfig.key === 'Type' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('Config')}
                  >
                    <div className="flex items-center">
                      Config
                      {sortConfig.key === 'Config' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('BUA_Numeric')}
                  >
                    <div className="flex items-center">
                      BUA (sqft)
                      {sortConfig.key === 'BUA_Numeric' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('Plot_Numeric')}
                  >
                    <div className="flex items-center">
                      Plot (sqft)
                      {sortConfig.key === 'Plot_Numeric' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('Launch_Price_M')}
                  >
                    <div className="flex items-center">
                      Launch Price
                      {sortConfig.key === 'Launch_Price_M' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('BUA_PSF_Numeric')}
                  >
                    <div className="flex items-center">
                      BUA PSF
                      {sortConfig.key === 'BUA_PSF_Numeric' && (
                        <span className="ml-1">{sortConfig.direction === 'ascending' ? '↑' : '↓'}</span>
                      )}
                    </div>
                  </th>
                  <th 
                    scope="col"
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    <div className="flex items-center">
                      Factors
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredProperties.map((property, index) => (
                  <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm font-medium text-blue-600">{property['Layout Name']}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className={`text-sm ${
                        property['Type'] === 'Beach Villa' ? 'text-blue-600' : 
                        property['Type'] === 'Coral Villa' ? 'text-red-600' : 
                        property['Type'] === 'Plots' ? 'text-green-600' : 'text-gray-900'
                      }`}>
                        {property['Type']}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{property['Config']}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{formatNumber(property['BUA_Numeric'])}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{formatNumber(property['Plot_Numeric'])}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{property['Launched Price (in AED)']}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{property['BUA PSF (in AED Per sqft)']}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{property['Factors']}</div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </main>
      
      {/* Footer */}
      <footer className="bg-white border-t border-gray-200 py-4">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <p className="text-sm text-gray-500">
            Palm Jebel Ali Property Data • March 2025
          </p>
        </div>
      </footer>
    </div>
  );
};

export default PalmJebelAliDashboard;
